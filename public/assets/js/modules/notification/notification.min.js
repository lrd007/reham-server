var $disabledSchedule = $("#schedule").is(':checked');
var quill = new Quill("#snow-editor", {
    theme: "snow",
    modules: {
        toolbar: [
            [{ font: [] }, { size: [] }],
            ["bold", "italic", "underline", "strike"],
            [{ color: [] }, { background: [] }],
            [{ script: "super" }, { script: "sub" }],
            [{ header: [!1, 1, 2, 3, 4, 5, 6] }, "blockquote", "code-block"],
            [
                { list: "ordered" },
                { list: "bullet" },
                { indent: "-1" },
                { indent: "+1" },
            ],
            ["direction", { align: [] }],
            ["link", "image", "video"],
            ["clean"],
        ],
    },
});

$('.select2').select2({
    placeholder: "Select"
});

$('#schedule-datetime').flatpickr({
    enableTime: true,
    dateFormat: "Y-m-d H:i"
});

$("#schedule").click(function () {

    $("#schedule-datetime").prop('disabled', $disabledSchedule);
    if ($disabledSchedule) {
        $("#schedule-datetime").val('');
        $("#statusField").val(0);
        $(this).val(0);
        $disabledSchedule = false;
        $("#sendNotification").prop('disabled', $disabledSchedule);
    } else {
        $disabledSchedule = true;
        $("#statusField").val(2);
        $(this).val(1);
        $("#sendNotification").prop('disabled', $disabledSchedule);
    }
});

$(".send-to-radio").click(function () {
    $val = $(this).val();
    console.log('inside function');
    $(".user-container, .group-container").hide();
    if ($val == '1') {
        $(".group-container").show();    
    } else {
        $(".user-container").show();
    }
});

$("#sendNotification").click(function () {
    $("#statusField").val(1);
    storeAndSendNotification(true);
});

$("#saveNotification").click(function () {
    $("#statusField").val(0);
    storeAndSendNotification();
});

function storeAndSendNotification($send = false) {
    $description = $("#snow-editor .ql-editor").html();
    $description = $description == '<p><br></p>' ? '' : $description;
    $("#message").text($description);
    $this = $("#saveNotification");
    $send ? disableButton($("#sendNotification")) : disableButton($("#saveNotification"));
    $form = $this.closest('form');
    $action = $form.attr('action');
    $method = 'post';
    if ($action) {
        $.ajax({
            type: $method,
            url: $action,
            data: new FormData($form[0]),
            dataType: 'json',
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.status = 'success') {
                    window.location.replace($baseUrl + '/admin/notificationcenter');
                }
            },
            error: function (error) {
                errorHandler(error);
                $send ? enableButton($("#sendNotification")) : enableButton($("#saveNotification"));
            }
        })
    }
}

$('#subscriber').select2({
    placeholder: $(this).data('placeholder') ?? "Select",
    ajax: {
        url: $baseUrl + '/admin/subscriber/by-email',
        dataType: 'json',
        delay: 250,
        processResults: function (data) {
            return {
                results: $.map(data, function (item) {
                    return {
                        text: item.name,
                        id: item.id
                    }
                })
            };
        }
    }
});

$(document).on('change', "#program", function () {
    $id = $(this).val();
    $("#course").prop('disabled', true);
    $.ajax({
        type: 'GET',
        url: $baseUrl + '/course-by-program-ids?program_ids=' + $id,
        dataType: 'json',
        success: function (response) {

            $row = '<option value=""></option >';
            $teachers = '';
            if (response.status = 'success') {
                if (response.courses) {
                    $.each(response.courses, function (index, course) {
                        $row += '<option value="' + course.id + '">' + course.name + '</option >';
                    });
                }

                $("#course").html($row), $("#course").prop('disabled', false);
            }
        },
        error: function (error) {
            errorHandler(error);
        }
    });
});

$(document).on('click', '.send-notification', function(){

    $self = $(this);
    disableButton($self);
    $form = $self.closest('form');
    $action = $form.attr('action');

    $.ajax({
        type: 'POST',
        url: $action,
        data: $form.serialize(),
        dataType: 'json',
        success: function(response) {
            if(response.status = 'success') {
                $successMessage = $isAr ? 'إرسال الإخطار.' : 'Notification Send.'
                toastr.success($successMessage);
            }
            enableButton($self);
        },
        error: function(error) {
            errorHandler(error);
            enableButton($self);
        }
    });
});